SET SERVEROUTPUT ON;
-- contar y copiar
CREATE TABLE USUARIO_INICICIAL (ID INTEGER PRIMARY KEY, NOMBRE VARCHAR2(40));
CREATE TABLE RESPALDO_USUARIOINICIAL(ID INTEGER , NOMBRE VARCHAR2(40));

DROP TABLE RESPALDO_USUARIOINICIAL;

INSERT INTO USUARIO_INICICIAL VALUES(1,'JUAN');
INSERT INTO USUARIO_INICICIAL VALUES(2,'ANA');
INSERT INTO USUARIO_INICICIAL VALUES(3,'ANA');

CREATE OR REPLACE PROCEDURE CONTAR(NUMERO OUT INTEGER)
AS
BEGIN
SELECT COUNT(*) INTO NUMERO FROM USUARIO_INICICIAL;

DBMS_OUTPUT.PUT_LINE('ENCONTRADOS  '||NUMERO);
END;
/

DECLARE 
VALOR INTEGER;
BEGIN
CONTAR(VALOR);
END;
/

-- EL QUE COPIA
CREATE OR REPLACE PROCEDURE COPIAR 
AS
CURSOR CUR_USUARIO_INICICIAL IS SELECT * FROM USUARIO_INICICIAL;
BEGIN
FOR REC IN CUR_USUARIO_INICICIAL LOOP
INSERT INTO RESPALDO_USUARIOINICIAL VALUES(REC.ID, REC.NOMBRE);
END LOOP;
END;
/

CREATE OR REPLACE TRIGGER DISP_USUARIO_INICIAL BEFORE INSERT ON USUARIO_INICICIAL FOR EACH ROW
DECLARE
VALOR INTEGER;
BEGIN
CONTAR(VALOR);
IF  VALOR = 3 THEN
COPIAR();
DELETE FROM USUARIO_INICICIAL;
END IF;
END;
/
------------------------------------------------------
INSERT INTO USUARIO_INICICIAL VALUES(4,'RAUL');
INSERT INTO USUARIO_INICICIAL VALUES(5,'CHANA');
INSERT INTO USUARIO_INICICIAL VALUES(6,'JUANA');

INSERT INTO USUARIO_INICICIAL VALUES(7,'ROQUE');

SELECT * FROM USUARIO_INICICIAL;
SELECT * FROM RESPALDO_USUARIOINICIAL;
DELETE  FROM USUARIO_INICICIAL;


---------------------------------------------------------------------------------------------------------------
CREATE TABLE TRABAJADOR1(ID INTEGER PRIMARY KEY, NOMBRE VARCHAR2(20), SUELDO_BASE FLOAT);
CREATE TABLE RESPALDO1(ID INTEGER PRIMARY KEY, NOMBRE VARCHAR2(20), SUELDO_BASE FLOAT);

--Generar un disparador que haga lo siguiente: Verificar que al insertar el tercer registro en la tabla trabajador, los borre  y los copie a los 3 en la tabla respaldo. 
--Siempre debe funcionar asi, jamas deberan haber mas de 3 registro en trabajador. 

INSERT INTO TRABAJADOR1 VALUES (1,'Juan',1600);
INSERT INTO TRABAJADOR1 VALUES (2,'Pedro',2000);
INSERT INTO TRABAJADOR1 VALUES (3,'Luis',1200);

CREATE OR REPLACE PROCEDURE CONTAR_TRABAJADOR1(NUMERO OUT INTEGER)
AS
BEGIN
SELECT COUNT(*) INTO NUMERO FROM TRABAJADOR;
END;
/

DECLARE 
VALOR INTEGER;
BEGIN
CONTAR_TRABAJADOR1(VALOR);
END;
/


CREATE OR REPLACE PROCEDURE COPIAR 
AS
CURSOR CUR_TRABAJADOR1 IS SELECT * FROM TRABAJADOR;
BEGIN
FOR REC IN CUR_TRABAJADOR1 LOOP
INSERT INTO RESPALDO1 VALUES(REC.ID, REC.NOMBRE, REC.SUELDO_BASE);
END LOOP;
END;
/

CREATE OR REPLACE TRIGGER DISP_TRABAJADOR1 BEFORE INSERT ON TRABAJADOR1 FOR EACH ROW
DECLARE
VALOR INTEGER;
BEGIN
CONTAR_TRABAJADOR1(VALOR);
IF  VALOR = 3 THEN
COPIAR();
DELETE FROM TRABAJADOR1;
END IF;
END;
/



INSERT INTO TRABAJADOR1 VALUES (4,'Jose',200);
INSERT INTO TRABAJADOR1 VALUES (5,'Ana',1500);
INSERT INTO TRABAJADOR1 VALUES (6,'Maria',100);

SELECT * FROM RESPALDO1;
SELECT * FROM TRABAJADOR1;


